<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta charset="utf-8" />
	<title>Tests of visualisations</title>
	<script src="highlight.min.js"></script>
	<link rel="StyleSheet" href="highlight.css" type="text/css" />
	<link rel="StyleSheet" href="style.css" type="text/css" />
	<style>
	</style>
</head>
<body class="b1-bg">

	<div class="holder padded">
	
		<h1>Tests of visualisations</h1>
		<ul class="menu">
			<li><a href="#iframe">type = iframe</a> <code class="status"><span class="ok">OK</span></code></li>
			<li><a href="#static-image">type = static-image</a> <code class="status"><span class="ok">OK</span></code></li>
			<li><a href="#table">type = table</a> <code class="status"><span class="ok">OK</span></code>
				<ul class="menu">
					<li><a href="#table-merge">simple merge cells</a></li>
					<li><a href="#table-heatmap">heatmap</a></li>
					<li><a href="#table-heatmap-rename">heatmap with renamed columns</a></li>
				</ul>
			</li>
			<li><a href="#line-chart">type = line-chart</a> <code class="status"><span class="ok">OK</span></code></li>
			<li><a href="#category-chart">type = category-chart</a> <code class="status"><span class="ok">OK</span></code></li>
			<li><a href="#hexmap">type = hexmap</a> <code class="status"><span class="error">Not done</span></code></li>
			<li><a href="#map">type = map</a> <code class="status"><span class="error">Not done</span></code></li>
			<li><a href="#dashboard">type = dashboard</a> <code class="status"><span class="error">Not done</span></code></li>
		</ul>
	</div>

	<section id="iframe">
		<div class="holder padded">
			<h2>type = iframe</h2>
			<div class="example">
				<style>
				iframe { width: 100%; aspect-ratio: 16 / 9; }
				cite { font-size: 0.8em; }
				</style>
				<script>
				function iframeBuilder(config){
					return '<iframe src="'+config.url+'"></iframe><br /><cite>Source: <a href="'+config.url+'" target="_opener">'+config.url+'</a></cite>';
				}
				</script>
				<pre class="yaml">
type: iframe
config:
  url: https://youthfuturesfoundation.org/wp-content/uploads/2022/03/Youth-Futures-Foundation-EGM-2022.html
				</pre>
			</div>
		</div>
	</section>

	<section id="static-image">
		<div class="holder padded">
			<h2>type = static-image</h2>
			<div class="example">
				<style>img { width: 100%; display: block; }</style>
				<script>
				function imageBuilder(config){
					return '<img src="'+config.file+'" alt="'+config.alt+'" />';
				}
				</script>
				<pre class="yaml">
type: static-image
config:
  file: https://dummyimage.com/982x400/777/fff.png&text=Main+Image
  alt: "Main image"   # Alt text for screen readers
				</pre>
			</div>
		</div>
	</section>

	<section id="table">
		<div class="holder padded">
			<h2>type = table</h2>
			<div class="example" id="table-merge">
				<p>An example of a table where some columns merge cells across rows using the <code>mergerows</code> value set to <code>true</code>. Note that we explicitly define each column we will show in the table. This allows us to ignore some columns in the source data file if we need to. We've explicitly centre-aligned text in the "Intervention" column by setting <code>align</code> to <code>center</code> (it could also be <code>left</code>, <code>right</code>, or <code>justify</code>)</p>
				<style>
				table { border-collapse: collapse; width: 100%; }
				table th { border: 0; font-weight: bold; font-family: Poppins, sans-serif; }
				table td { border: 1px solid black; }
				table td:first-child { border-left: 0; }
				table td:last-child { border-right: 0; }
				table td, table th { line-height: 1.5em; padding: 0.25em; }
				</style>
				<pre class="yaml">
type: table
config:
  data: data-table.csv  # A simple table in a CSV file with one header row
  columns:              # The ability to merge rows (in a specific column) that have the same value
    - name: "Overall category"
      mergerows: true   # In this column we merge rows that have the same value
    - name: "Intervention"
      mergerows: true   # In this column we merge rows that have the same value
      align: center     # Align the text in the cell
    - name: "Sub-category"
				</pre>
			</div>
			
			<div class="example" id="table-heatmap">
				<p>This example creates a table but turns certain columns into <code>heatmap</code> types. A heatmap column can have optional <code>scale</code>, <code>min</code>, and <code>max</code> values. If not given, the <code>scale</code> will default to <code>YFF</code>. If the <code>min</code> and <code>max</code> aren't given they default to the lowest and highest values in the column. If you want the colour scale values to match across columns you should make sure to explicitly set the <code>min</code> and <code>max</code>.</p>
				<style>
				table { border-collapse: collapse; width: 100%; }
				table th { border: 0; font-weight: bold; font-family: Poppins, sans-serif; }
				table td { border: 1px solid black; }
				table td:first-child { border-left: 0; }
				table td:last-child { border-right: 0; }
				table td, table th { line-height: 1.5em; padding: 0.25em; }
				</style>
				<pre class="yaml">
type: table
config:
  data: data-heatmap.csv
  columns:
    - name: "Ranks→2018"
      align: center
      heatmap: true
      scale: YFF
      min: 1
      max: 38
    - name: "Ranks→2019"
      align: center
      heatmap: true
      scale: YFF
      min: 1
      max: 38
    - name: "Ranks→2020"
      align: center
      heatmap: true
      scale: YFF
      min: 1
      max: 38
    - name: "Country"
    - name: "Index→2018"
      align: center
      heatmap: true
      scale: YFF
      min: 71
      max: 23
    - name: "Index→2019"
      align: center
      heatmap: true
      scale: YFF
      min: 71
      max: 23
    - name: "Index→2020"
      align: center
      heatmap: true
      scale: YFF
      min: 71
      max: 23
				</pre>
			</div>
			<div class="example" id="table-heatmap-rename">
				<p>This example makes a heatmap table. It renames specific columns using <code>rename</code>. A renamed column will have a single header label.</p>
				<style>
				table { border-collapse: collapse; width: 100%; }
				table th { border: 0; font-weight: bold; font-family: Poppins, sans-serif; vertical-align: top; }
				table td { border: 1px solid black; }
				table td:first-child { border-left: 0; }
				table td:last-child { border-right: 0; }
				table td, table th { line-height: 1.5em; padding: 0.25em; }
				</style>
				<pre class="yaml">
type: table
config:
  data: data-gapmap.csv
  columns:
    - name: "Source→Name"
      rename: "Source"
    - name: "Ethnic groups availability→Broad groupings (e.g. White, Black, Asian, mixed, other)→Rating"
      rename: "Broad groupings e.g. White, Black, Asian, mixed, other"
      width: "15%"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
    - name: "Ethnic groups availability→Ethnic groups (e.g. African, Carribean, other black background)→Rating"
      rename: "Ethnic groups e.g. African, Carribean, other black background"
      width: "15%"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
    - name: "Ethnic groups availability→Ethnic subgroups (e.g. Somali)→Rating"
      rename: "Ethnic subgroups e.g. Somali"
      width: "15%"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
    - name: "Ethnic groups availability→Other relevant subgroups (e.g. migration status)→Rating"
      rename: "Other relevant subgroups e.g. migration status"
      width: "15%"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
				</pre>
			</div>

		<div class="example" id="table-heatmap-rename">
			<p>This is an example chart to support Narrative Point 1: Systemic Erasure, demonstrating a lack of data available to perform intersectional analysis.</p>
			<style>
			table { border-collapse: collapse; width: 100%; }
			table th { border: 0; font-weight: bold; font-family: Poppins, sans-serif; vertical-align: top; }
			table td { border: 1px solid black; }
			table td:first-child { border-left: 0; }
			table td:last-child { border-right: 0; }
			table td, table th { line-height: 1.5em; padding: 0.25em; }
			</style>
			<pre class="yaml">
type: table
config:
  data: data-gapmap.csv
  columns:
    - name: "Source→Name"
      rename: "Source"
    - name: "Intersectional analysis→Two-way intersectional analysis (e.g. ethnic group by demographic characteristic)→Rating"
      rename: "Two-way intersectional analysis (e.g. ethnicity by demographic)"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
    - name: "Intersectional analysis→Three-way intersectional analysis possible (e.g. ethnic group by demographic characteristic by region)→Rating"
      rename: "Three-way intersectional analysis (e.g. ethnicity by demographic by region)"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
			</pre>
		</div>


		<div class="example" id="table-heatmap-rename">
			<p>This is an example chart to support Narrative Point 3: Lack of Culturally Relevant Data.</p>
			<style>
			table { border-collapse: collapse; width: 100%; }
			table th { border: 0; font-weight: bold; font-family: Poppins, sans-serif; vertical-align: top; }
			table td { border: 1px solid black; }
			table td:first-child { border-left: 0; }
			table td:last-child { border-right: 0; }
			table td, table th { line-height: 1.5em; padding: 0.25em; }
			</style>
			<pre class="yaml">
type: table
config:
  data: data-gapmap.csv
  columns:
    - name: "Source→Name"
      rename: "Source"
    - name: "Relevance of data→Culturally relevant data available→Rating"
      rename: "Culturally Relevant Data Available"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
    - name: "Relevance of data→Timeliness of data (e.g. covers a suitable time period, sufficiently up to date)→Rating"
      rename: "Timeliness of data"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
			</pre>
		</div>


		<div class="example" id="table-heatmap-rename">
			<p>This is an example chart to demonstrate the lack of data available on employment, and particularly on discrimination in employment.</p>
			<style>
			table { border-collapse: collapse; width: 100%; }
			table th { border: 0; font-weight: bold; font-family: Poppins, sans-serif; vertical-align: top; }
			table td { border: 1px solid black; }
			table td:first-child { border-left: 0; }
			table td:last-child { border-right: 0; }
			table td, table th { line-height: 1.5em; padding: 0.25em; }
			</style>
			<pre class="yaml">
type: table
config:
  data: data-gapmap.csv
  columns:
    - name: "Source→Name"
      rename: "Source"
    - name: "Employment data→Employment status→Rating"
      rename: "Employment Status"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
    - name: "Employment data→Sector→Rating"
      rename: "Sector"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
    - name: "Employment data→Occupation→Rating"
      rename: "Occupation"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
    - name: "Employment data→Contract type→Rating"
      rename: "Contract Type"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
    - name: "Employment data→Apprenticeships→Rating"
      rename: "Apprenticeship"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
    - name: "Employment data→Pay→Rating"
      rename: "Pay"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
    - name: "Employment data→Progression→Rating"
      rename: "Progression"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
    - name: "Employment data→Discrimination in employment→Rating"
      rename: "Discrimination in Employment"
      align: center
      heatmap: true
      scale: YFF
      min: 3
      max: 0
			</pre>
		</div>
	</div>
</section>

	
	<section id="line-chart">
		<div class="holder padded">
			<h2>type = line-chart</h2>
			<div class="example">
				<p>This example makes a line-chart. Rather than <code>columns</code> we define <code>series</code>. Each <code>series</code> can have:</p>
				<ul>
					<li><code>title</code> - the displayed title (in the key and tooltip)</li>
					<li><code>value</code> - the name of the CSV column to use from the CSV. As in tables, multi-line column headings get concatenated with a "→".</li>
					<li><code>tooltip</code> - the name of the CSV column to use as a tooltip. If not set one will be created.</li>
					<li><code>colour</code> - the hex colour to use for this series.</li>
				</ul>
				<p>Each axis can be defined in <code>axis</code> with the following properties:</p>
				<ul>
					<li><code>min</code> - the minimum value for the axis</li>
					<li><code>max</code> - the maximum value for the axis</li>
					<li><code>grid</code> - define some properties (<code>stroke</code>, <code>stroke-dasharray</code>, and <code>stroke-width</code>) of the grid lines for this axis. By default the grid is turned off. In this example we have made grid lines for each year but only labelled every 5 years.</li>
					<li><code>ticks</code> - explicitly define each tick with <code>value</code> and <code>label</code>.</li>
				</ul>
				<p>The vertical axis (<code>y</code>) values for <code>min</code>, <code>max</code>, and <code>ticks</code> will be set automatically.</p>

				<pre class="yaml" id="line-chart-yaml">
type: line-chart
config:
  data: data-line-chart.csv   # A basic CSV file with each series in a column
  source: "Table 9: Unemployment by age and duration (seasonally adjusted) 19 July 2022 from A01: Summary of labour market statistics https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/datasets/summaryoflabourmarketstatistics"
  key:
    show: true     # Default to false
    position: "top right"
  axis:
    x:  # Horizontal axis
      min: 2001    # A minimum value
      max: 2022    # A maximum value
      grid:
        stroke: "#efefef"
      # Explicitly define the ticks.
      # Each tick has a numeric value and a displayed label
      ticks:
        - value: 2001
          label: ""
        - value: 2002
          label: ""
        - value: 2003
          label: ""
        - value: 2004
          label: ""
        - value: 2005
          label: "2005"
        - value: 2006
          label: ""
        - value: 2007
          label: ""
        - value: 2008
          label: ""
        - value: 2009
          label: ""
        - value: 2010
          label: "2010"
        - value: 2011
          label: ""
        - value: 2012
          label: ""
        - value: 2013
          label: ""
        - value: 2014
          label: ""
        - value: 2015
          label: "2015"
        - value: 2016
          label: ""
        - value: 2017
          label: ""
        - value: 2018
          label: ""
        - value: 2019
          label: ""
        - value: 2020
          label: "2020"
        - value: 2021
          label: ""
    y:             # The vertical axes
      min: 0       # A minimum value
      max: 50      # A maximum value
      title:
        label: "Unemployment Rate %"
      dominant-baseline: text-bottom
      # Explicitly define the ticks.
      # Each tick has a numeric value and a displayed label
      ticks:
        - value: 0
          grid: true
          label: "0"
        - value: 5
          grid: true
          label: "5"
        - value: 10
          grid: true
          label: "10"
        - value: 15
          grid: true
          label: "15"
        - value: 20
          grid: true
          label: "20"
        - value: 25
          grid: true
          label: "25"
        - value: 30
          grid: true
          label: "30"
        - value: 35
          grid: true
          label: "35"
        - value: 40
          grid: true
          label: "40"
        - value: 45
          grid: true
          label: "45"
  series:
    - title: "16-17"
      x: "Year"                       # Column heading to use for x-value
      y: "16-17→rate (%)1"            # Column heading to use fro y-value
      size: 10
    - title: "18-24"                  # Displayed in the key and tooltip
      x: "Year"
      y: "18-24→rate (%)1"
    - title: "25-49"                  # Displayed in the key and tooltip
      x: "Year"
      y: "25-49→rate (%)1"
    - title: "50-64"                  # Displayed in the key and tooltip
      x: "Year"
      y: "50 and over→rate (%)1"
 				</pre>
			</div>
		</div>
	</section>


	<section id="category-chart">
		<div class="holder padded">
			<h2>type = category-chart</h2>
			<div class="example">
				<p>This example makes a basic category chart (which is a specially-formatted version of a line-chart). Rather than <code>columns</code> we define <code>series</code>. Each <code>series</code> can have:</p>
				<ul>
					<li><code>title</code> - the displayed title (in the key and tooltip)</li>
					<li><code>value</code> - the name of the CSV column to use from the CSV. As in tables, multi-line column headings get concatenated with a "→".</li>
					<li><code>errors</code> - an array that defines the left and right error bar sizes. The first error bar is subtracted from the value and the second is added.</li>
					<li><code>tooltip</code> - the name of the CSV column to use as a tooltip. If not set one will be created.</li>
					<li><code>colour</code> - the hex colour to use for this series.</li>
				</ul>
				<p>Each axis can be defined in <code>axis</code> with the following properties:</p>
				<ul>
					<li><code>min</code> - the minimum value for the axis</li>
					<li><code>max</code> - the maximum value for the axis</li>
					<li><code>grid</code> - define some properties (<code>stroke</code>, <code>stroke-dasharray</code>, and <code>stroke-width</code>) of the grid lines for this axis. By default the grid is turned off.</li>
					<li><code>ticks</code> - explicitly define each tick with <code>value</code> and <code>label</code>.</li>
				</ul>
				<p>The vertical axis (<code>y</code>) values for <code>min</code>, <code>max</code>, and <code>ticks</code> will be set automatically.</p>
				<pre class="yaml" id="category-chart-yaml">
type: category-chart
config:
  data: data-category-chart.csv
  # Define the axis
  key:
    show: true     # Default to false
    position: "top right"
  axis:
    x:
      min: 15
      max: 58
      grid:
        stroke-dasharray: "6 2"
        stroke-width: 1
      ticks:
        - value: 20
          label: "20%"
        - value: 30
          label: "30%"
        - value: 40
          label: "40%"
        - value: 50
          label: "50%"
    y:
      grid:
        stroke-width: 0.5
  # Category names come from 
  category: "Ethnic group"
  series:
    - title: "Female"
      value: "Female→Value (%)"
      errors: ["Female→Uncertainty minus (%)","Female→Uncertainty plus (%)"]   # The column headings to use for the lower/upper error bar (value-lower and value+upper)
    - title: "Male"
      value: "Male→Value (%)"
      errors: ["Male→Uncertainty minus (%)","Male→Uncertainty plus (%)"]  # The column headings to use for the lower/upper error bar size
				</pre>
			</div>




			<div class="example">
				<p>Dummy data to show lots of values.</p>
				<pre class="yaml" id="category-chart-yaml">
type: category-chart
config:
  data: data-employment-by-region.csv
  # Define the axis
  key:
    show: true     # Default to false
    position: "top right"
  axis:
    x:
      min: 0
      max: 100
      grid:
        stroke-dasharray: "6 2"
        stroke-width: 1
      ticks:
        - value: 25
          label: "25%"
        - value: 50
          label: "50%"
        - value: 75
          label: "75%"
    y:
      grid:
        stroke-width: 0.5
  category: "Region"  # Category names come from
  series:
    - title: "Bangladeshi"
      value: "Bangladeshi→Value (%)"
      errors: ["Bangladeshi→- (%)","Bangladeshi→+ (%)"]   # The column headings to use for the lower/upper error bar (value-lower and value+upper)
    - title: "Black/African/Caribbean/Black British"
      value: "Black/African/Caribbean/Black British→Value (%)"
      errors: ["Black/African/Caribbean/Black British→- (%)","Black/African/Caribbean/Black British→+ (%)"]   # The column headings to use for the lower/upper error bar (value-lower and value+upper)
    - title: "Chinese"
      value: "Chinese→Value (%)"
      errors: ["Chinese→- (%)","Chinese→+ (%)"]   # The column headings to use for the lower/upper error bar (value-lower and value+upper)
    - title: "Indian"
      value: "Indian→Value (%)"
      errors: ["Indian→- (%)","Indian→+ (%)"]   # The column headings to use for the lower/upper error bar (value-lower and value+upper)
    - title: "Mixed/Multiple"
      value: "Mixed/Multiple→Value (%)"
      errors: ["Mixed/Multiple→- (%)","Mixed/Multiple→+ (%)"]   # The column headings to use for the lower/upper error bar (value-lower and value+upper)
    - title: "Other"
      value: "Other→Value (%)"
      errors: ["Other→- (%)","Other→+ (%)"]   # The column headings to use for the lower/upper error bar (value-lower and value+upper)
    - title: "Pakistani"
      value: "Pakistani→Value (%)"
      errors: ["Pakistani→- (%)","Pakistani→+ (%)"]   # The column headings to use for the lower/upper error bar (value-lower and value+upper)
    - title: "Other Asian"
      value: "Other Asian→Value (%)"
      errors: ["Other Asian→- (%)","Other Asian→+ (%)"]   # The column headings to use for the lower/upper error bar (value-lower and value+upper)
    - title: "White"
      value: "White→Value (%)"
      errors: ["White→- (%)","White→+ (%)"]   # The column headings to use for the lower/upper error bar (value-lower and value+upper)
				</pre>
			</div>




		</div>
	</section>


	<section id="hexmap">
		<div class="holder padded">
			<h2>type = hexmap</h2>
			<div class="example">
				<pre class="yaml">
type: hexmap
config:
  data: file.csv
  layout: layout.hexjson  # A HexJSON file
  column-id: column-heading-for-id
  column-value: column-heading-for-value
  column-label: column-heading-for-label  # If not given we can build a label of the form "column-heading-for-id: column-heading-for-value"
  scale: Viridis # a named colour scale (we can have a default)
  min: 0    # optional explicit minimum for scale
  max: 100 # optional explicit maximum for scale
				</pre>
			</div>
		</div>
	</section>

	<section id="map">
		<div class="holder padded">
			<h2>type = map</h2>
			<div class="example">
				<pre class="yaml">
type: map
config:
  data: file.csv
  layout: polygons.geojson    # A GeoJSON file
  column-id: column-heading-for-id
  column-value: column-heading-for-value
  column-label: column-heading-for-label  # If not given we can build a label of the form "column-heading-for-id: column-heading-for-value"
  scale: Viridis # a named colour scale (we can have a default)
  min: 0    # optional explicit minimum for scale
  max: 100 # optional explicit maximum for scale
				</pre>
			</div>
		</div>
	</section>

	<section id="dashboard">
		<div class="holder padded">
			<h2>type = dashboard</h2>
			<div class="example">
				<pre class="yaml">
type: dashboard
config:
  data: file.csv # A basic CSV file
  column-title: column-heading-for-title  # Appears above the number
  column-value: column-heading-for-value  # The number to show
  column-units-pre: column-heading-for-units  # optional column that defines a unit that goes before a number e.g. £
  column-units-post: column-heading-for-units # optional column that defines a unit that goes after the number e.g. %
  column-footnote: column-heading-for-footnote    # optional column that appears below the number
  # Question: do we need to set colours per panel or can we be consistent like https://open-innovations.github.io/leeds-digital-festival-data/ ?
				</pre>
			</div>
		</div>
	</section>



	<script src="charts.js"></script>
	<script src="util.js"></script>
	<script src="colour.js"></script>
	<script src="js-yaml.js"></script>
	<script src="interactive.js"></script>

	<script>
	var blocks = [];
	var OI = {};
	OI.ready = function(fn){
		// Version 1.1
		if(document.readyState != 'loading') fn();
		else document.addEventListener('DOMContentLoaded', fn);
	};
	OI.ready(function(){
		function tidy(t){ return t.replace(/===NEWLINE===/g,"\n").replace(/\n*$/,"").replace(/^\n*/,"").replace(/[\n\t]*$/,""); }
		function sanitise(t){ return t.replace(/\</g,"&lt;").replace(/\>/g,"&gt;"); }
		function deindent(t){
			var n = 0;
			for(i = 0; i < t.length; i++){
				if(t[i]=='\t'){ n++; }
				else{ break; }
			}
			if(n > 0){
				return t.replace(new RegExp("(^|\n)[\\t]{"+n+"}",'g'),function(m,p1){ return p1; });
			}
			if(n==0){
				for(i = 0; i < t.length; i++){
					if(t[i]==' '){ n++; }
					else{ break; }
				}
				if(n > 0) return t.replace(new RegExp("(^|\n)[\\s]{"+n+"}",'g'),function(m,p1){ return p1; });
			}
			return t;
		}
		
		document.querySelectorAll('.example').forEach(el => {
			var yml,html,t,yaml,d;
			yml = "";
			html = "";
			yaml = {};

			block = {'el':{'main':el,'yaml':el.querySelector('.yaml')},'txt':el.innerHTML,'yaml':{}};

			if(block.el.yaml){
				block.el.yaml.innerHTML = deindent(tidy(block.el.yaml.innerHTML));
				yml = block.el.yaml.innerHTML;
				hljs.highlightElement(block.el.yaml)
				t = document.createElement('h3');
				t.innerHTML = "YAML";
				block.el.yaml.insertAdjacentElement('beforebegin', t);
				yaml = jsyaml.load(yml);
			}
			// Insert <pre> version of CSS styles
			el.querySelectorAll('style').forEach(el => {
				var t = document.createElement('h3');
				t.innerHTML = 'CSS';
				var d = document.createElement('pre');
				d.classList.add('css');
				d.innerHTML = deindent(tidy(el.innerHTML));
				el.insertAdjacentElement('afterend',d);
				el.insertAdjacentElement('afterend',t);
				hljs.highlightElement(d)
			});
			
			// Insert <pre> version of Javascript
			js = '';
			fn = '';
			el.querySelectorAll('script').forEach(elinner => { js += deindent(tidy(elinner.innerHTML)); });
			js = js.replace(/\n/g,"===NEWLINE===");
			js = js.replace(/^function ([^\(]+)\(([^\)]*)\)\{(.*)\}$/,function(m,p1,p2,p3){ fn = p1; return deindent(tidy(p3)); })
			if(js){
				var t = document.createElement('h3');
				t.innerHTML = 'JS';
				el.querySelector('script').insertAdjacentElement('afterend',t);
				var d = document.createElement('pre');
				d.classList.add('js');
				d.innerHTML = js.replace(/\</g,"&lt;").replace(/\>/g,"&gt;");
				t.insertAdjacentElement('afterend',d);
				hljs.highlightElement(d);
				if(typeof window[fn]==="function") html = window[fn].call(this,yaml.config)||"";
				
				if(typeof html==="string"){
					makeOutput(el,yaml,html);
				}else{
					let result = html.then(function(response){
						makeOutput(el,yaml,response);
						return response;
					})
				}
			}else{
				processType(yaml,el);
			}
			block.yaml = yaml;

			blocks.push(block);
			return;
		});

	});

	function processType(yaml,el){
		var config = yaml.config;
		if(yaml.type=="table" || yaml.type=="line-chart" || yaml.type=="category-chart"){
			fetch(config.data).then(response => {
				if(!response.ok) throw new Error('Network response was not OK');
				return response.text();
			}).then(txt => {
				var csv = CSV2JSON(txt);
				var html = "";
				config.colours = {
					"Female":"#ee7e3b","Male":"#264c59",
					"Bangladeshi":"#7D2248","Black/African/Caribbean/Black British":"#75b8d3","Chinese":"#fe9400", "Indian":"#274b57","Mixed/Multiple":"#E55912","Other":"#0685cc","Pakistani":"#874245","Other Asian":"#39c2b0","White":"#fdc358",
					"Any other religion":"#69C2C9","Buddhist":"#C7B200","Christian":"#E55912","Hindu":"#874245","Jewish":"#7D2248","Muslim":"#005776","None":"#fdc358","Sikh":"#69C2C9",
					"16-17":"#E52E36","18-24":"#F7AB3D","25-49":"#C7B200","50-64":"#005776"
				};
				if(yaml.type=="table"){
					html = buildTable(config,csv);
				}else if(yaml.type=="line-chart"){
					chart = new LineChart(config,csv);
					html = chart.getSVG();
				}else if(yaml.type=="category-chart"){
					chart = new CategoryChart(config,csv);
					html = chart.getSVG();
				}

				// Update the DOM with the generated HTML
				makeOutput(el,yaml,html);

			}).catch(error => {
				console.error('Unable to load the data "'+config.data+'"',error);
			});
		}
	}

	function makeOutput(el,yaml,html){
		var t = document.createElement('h3');
		t.innerHTML = "Output";
		el.insertBefore(t, el.firstChild);
		var out = document.createElement('div');
		out.classList.add('output');
		out.innerHTML = "Type: "+yaml.type;
		t.insertAdjacentElement('afterend', out);
		out.innerHTML = html;

		// Add interactivity
		if(yaml.type=="line-chart" || yaml.type=="category-chart") new InteractiveChart(out);
	}


	</script>
	
</body>
</html>